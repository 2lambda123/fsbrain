---
title: "nitools: Utility Functions for the Analysis of Structural Neuroimaging Data in GNU R"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Analysis of structural neuroimaging data with nitools}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

In this document, we demonstrate some high-level functions for loading and analysing structural neuroimaging data preprocessed with [FreeSurfer](https://surfer.nmr.mgh.harvard.edu). FreeSurfer stores its output in a directory structure with fixed subfolder names. This package implements several high-level functions that allow the user to access surface-based brain structure data for large groups of subjects with very little code. It also supports the computation of statistics for individual brain structures or brain atlas regions for brain morphometry measures. Statistical analysis can then be performed using standard methods implemented in other packages.

Note: While this packages provides an abstract access layer to neuroimaging data, it does *not* implement file readers. It uses the 'freesurferformats' package in the background to parse the file formats.

## Accessing morphometry data for groups of subjects


To open a single file directly, all you would need is 'freesurferformats':

```{r, eval = FALSE}
    library("freesurferformats");
    cortical_thickness = read.fs.morph("study_dir/subject1/surf/lh.thickness");
```


### Native space

The nitools package provides a high-level interface to access data for groups of subjects. Here, we compute the mean thickness for each subject in native space:

```{r, eval = FALSE}
    library("nitools");
    subjects_dir = path.expand("~/data/study1")
    subjects_list = c("subject1", "subject2", "subject3", "subject4", "subject5")
    mean_thickness_lh = group.morph.agg.native(subjects_dir, subjects_list, "thickness", "lh", agg_fun=mean)
```


### Standard space

Here, we compute the mean thickness for each subject in standard space:

```{r, eval = FALSE}
    library("nitools");
    subjects_dir = path.expand("~/data/study1")
    subjects_list = c("subject1", "subject2", "subject3", "subject4", "subject5")
    mean_thickness_lh = group.morph.agg.standard(subjects_dir, subjects_list, "thickness", "lh", fwhm="10", agg_fun=mean)
```


## Aggregating over atlas regions

When working with native space data for groups, vertex-wise comparison is not possible and one if often interested in aggregating data or summary statistics. Obtaining these for a group becomes easy with 'nitools':


```{r, eval = FALSE}
  subjects_dir = file.path("study_dir")
  subjects_list = c("subject1", "subject2", "subject3")  # You may want to read them from a subjects file instead if you have many
  data = group.multimorph.agg.native(subjects_dir, subjects_list, c("thickness", "area", "volume"), c("lh", "rh"), agg_fun = mean);
```

This gives you a dataframe that contains the following columns:

* `subject_id`
* `hemi`
* `thickness`
* `area`
* `volume`

The values are the mean thickness/area/volume over all vertices of the subject, computed from the respective native space morphometry files (e.g., 'subject1/surf/lh.thickness', 'subject2/surf/lh.thickness', and so on).

You could do the same in standard space with `group.multimorph.agg.native()`, even though it's not very common.


## Mapping one result value to each brain atlas region

Mapping a single value to an atlas region of a subject (usually a template subject like fsaverage) is useful to display results, like p values or effect sizes, on the brain surface. Here is an example script that uses nitools to do that:

```{r, eval = FALSE}
library("nitools")

hemi = "lh"               # 'lh' or 'rh'
atlas = "aparc"           # an atlas, e.g., 'aparc', 'aparc.a2009s', 'aparc.DKTatlas'

template_subjects_dir = "/Applications/freesurfer/subjects";    # Some directory where we can find fsaverage. This can be omitted if FREESURFER_HOME is set, the function will find fsaverage in there by default.

# One can also retrieve all region names of an atlas. This would get all 36 aparc regions:
region_names_aparc = nitools::get.atlas.region.names('aparc', template_subjects_dir=template_subjects_dir);
region_value_list = as.list(rnorm(length(region_names_aparc), mean=5, sd=1.5)); # assign some random normal values for this example. One would put effect size values or whatever here. The order of values has to match the order of the region names.
names(region_value_list) = region_names_aparc;    # Assign the names to the values.

ret = nitools::fs.write.region.values.fsaverage(hemi, atlas, region_value_list, output_file="/tmp/spread.mgz", template_subjects_dir=template_subjects_dir, show_freeview_tip=TRUE);
```

This code will write an MGZ file that can be visualized in FreeView or Matlab/Surfstat.


